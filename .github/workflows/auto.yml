name: Deploy to Windows Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v2

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '5.0.x'

      - name: Build and publish .NET Core project
        run: dotnet publish -c Release -o ${{ hafizkamranarshad/test.git }}/publish

      - name: Deploy to Windows Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          source: '${{ hafizkamranarshad/test.git }}/publish/*'
          target: '/var/www/html/myapp/'
          script: |
            $ErrorActionPreference = "Stop"
            $Session = New-PSSession -ComputerName ${{ secrets.HOST }} -Credential (New-Object System.Management.Automation.PSCredential (${{ secrets.USERNAME }}, (ConvertTo-SecureString -String ${{ secrets.PASSWORD }} -AsPlainText -Force)))
            Invoke-Command -Session $Session -ScriptBlock { Remove-Item -Path "C:\inetpub\wwwroot\myapp" -Recurse -Force }
            Invoke-Command -Session $Session -ScriptBlock { New-Item -ItemType Directory -Path "C:\inetpub\wwwroot\myapp" }
            Invoke-Command -Session $Session -ScriptBlock { Copy-Item -Path "/var/www/html/myapp/*" -Destination "C:\inetpub\wwwroot\myapp" -Recurse }
            Invoke-Command -Session $Session -ScriptBlock { Import-Module WebAdministration }
            Invoke-Command -Session $Session -ScriptBlock { New-WebApplication -Site 'Default Web Site' -Name 'myapp' -PhysicalPath 'C:\inetpub\wwwroot\myapp' -ApplicationPool '.NET v5.0' }
            Invoke-Command -Session $Session -ScriptBlock { Stop-WebAppPool -Name '.NET v5.0' }
            Invoke-Command -Session $Session -ScriptBlock { Start-WebAppPool -Name '.NET v5.0' }
            Invoke-Command -Session $Session -ScriptBlock { Exit-PSSession }
